# MTG関連
- 実施日： 毎週月曜日（実施不可の場合は水曜日）
- リンク： https://meet.google.com/wgp-owqc-sva

# 現行タスク（暫定記載）
## タスク一覧（10月対応予定分）：チェックしたら完了

<details>
<summary>詳細</summary>

### ソフトバグ関連
- [ ] モード切替時にびくつく
  - [x] 平尾対処
  - [ ] 中村さん確認
- [ ] モード切替中にびくびくを続ける
  - [x] 平尾対処
  - [ ] 中村さん確認
- [ ] 4m以上進む指示を出すと止まらなくなる
  - [x] 平尾対処
  - [ ] 中村さん確認
### ハード故障関連
- [x] ヒューズ切れ
  - [x] 平尾対処
  - [x] 中村さん確認
- [ ] 右モータ故障
  - [ ] 平尾対処
    - [ ] 原因確認：以下候補
      - [x] モータ故障
      - [x] ESC故障
      - [x] ESC→RC8への過電流供給:これが原因ぽい
      - [x] Arduinoシールド故障
  - [ ] 中村さん確認  
### 機能追加関連
- [ ] 位置制御関連の実装
  - [ ] 平尾対処
    - [x] 速度制御の上に位置制御をかぶせる：意識合わせ済み  
    - [x] 目標位置偏差からPID制御ロジックの実装
    - [x] 速度上限の180rpm異常の速度入力させない実装
    - [x] susumu コマンドの追加（距離,目標速度上限）の追加　指定しない場合は90
    - [x] susumu以外 コマンドの追加（距離,目標速度上限）の追加　指定しない場合は90
    - [x] 制御停止条件：意識合わせ済み
    - [ ] パラメータフィッティング
  - [ ] 中村さん確認
- [ ] リファクタリング（優先度：低）
  - [ ] 平尾対処
    - [x] 400行退避
    - [ ] 全退避 
  - [ ] 中村さん確認

</details>

## タスク一覧（11月対応以降予定分）

<details>
<summary>詳細</summary>

- [ ] 制御ロジックの更新
  - [ ] ２輪制御への対応
  - [ ] 任意のルート、速度への追従制御
  - [ ] 位置偏差から直接サーボ入力の制御ロジックの実装
  - [ ] 速度上限制御の要件に合わせた具体化
    - [ ] 2自由度制御の実装：FFとFBの組み合わせ
  - [ ] 制御停止条件の精緻化（ある程度落ち着いたら停止等）
  - [ ] 車体回転の制御を任意の度数に対応
  - [ ] より精緻なパラメータフィッティング
- [ ] motorconntorllerの更新
  - [ ] 位置偏差制御ロジック対応
  - [ ] リファクタリング
  - [ ] エンコーダーカウントを初期化させずにモードチェンジができるようにしたい
- [ ] リファクタリング
  - [ ] 単純に見た目の整理
- [ ] ECS→RC8への供給電源過多への対処


</details>



# 進捗メモ

## 2022/10/ 30：作業
<details>
<summary>詳細</summary>
- リファクタリング 1330→548
  - 制御周りや停止についてはまだ触る可能性あるため退避せず。それ以外の退避できそうなのは退避。
  - このサービスの用途誰向け？とかが知りたい。いまだにイメージがフワフワしている。教育目的だけ？５ＷＩＨ的に知りたい。
    - 一度どこかでの利用用途に参加した方がイメージわきやすいかも
</details>

## 2022/10/26：作業
<details>
<summary>詳細</summary>
- susumu以外に速度上限コマンドの追加修正完了
</details>

## 2022/10/26：作業
<details>
<summary>詳細</summary>

- バグの確認
  - arduino_cmd_matrixをlong intで定義して解決
    - グローバル変数８４％になり動作不安定に
    - コメント減らしてなんとか８１％に要相談
- 機能追加
  - 速度上限180rpmを超えないように追加
- ユーザの任意の速度上限ってほんとにいるの？回転角度すら45度刻みなんだけども、一旦susumuだけ導入する？ 
- 目標速度上限の追加　指定しない場合は90 susumuは実装済みそれ以外はばぐあり？要確認
- コメント複製:2点報告です。
  - ①４ｍ以上進むと進み続けるバグ
    - 対処方法としてarduino_cmd_matrix　をlong intで定義することで解決しました。ただし、メモリがさらに圧迫されている状況です。※現行ではグローバル変数で８１％消費中一旦バグとしては対処完了しましたのでご報告です。
  - ②起動中右モータが動かなくなる事象について
    - デバッグ以外の時間もバッテリオンにしていたために起こっていた事象のようです。本日はデバッグ以外の時間はこまめにon/offしていますが一度右モータの故障は再現していません。やはり、RC8への電流消費が原因のようです。こちらは経過報告になります。
- 今日はここまで 

</details>

## 2022/10/25：作業
<details>
<summary>詳細</summary>

- mdの整理整頓
- ４ｍ超えた際のバグ確認
  - 値を確認
</details>

## 2022/10/22：作業兼24MTG
<details>
<summary>詳細</summary>

- ハード不具合確認：解決済
  - 新バッテリー交換のみでは動作せず（充電後再トライ失敗）
  - 電源スイッチは動作不良なし、オン通電、オフ絶縁
  - 左モーター動かず：モーター単体とエンコーダーも個別に動くこと確認済み
    - ただの接触不良
  - 原因：ヒューズ切れと左モーターケーブル接触不良
  - 左モーター動作不良
    - 同じ条件でもついたりつかなかったりしたので、接触不良？
- バグFIX
  - 切り替え中に暴れる：FIX済
    - 各種初期化をモードが最初に切り替わったときに変更RC→ARDUINO
    - ★仕様通り モードを切替した最初の瞬間にモードチェンジ
  - 切り替え瞬間に暴れる：FIX済
    - calcRpmのLPFが原因
      - エンコーダー値を初期化で対応　motorcontrollerの一部変更これでよい？エンコーダー初期化しない対応するにしても、motorcontroller側でのコード変更は必須（モード切替時のエンコーダー値の退避の対応）
      - motorcontrollerはエンコーダー初期化しているためROS等との整合性確認：確認
      - ★motorcontroller含めて将来対応
  - エンコーダーの値が振り切れる件：要確認
    - 事象再現ならず、対処は入れているのでMTGにて試験したい
    - これは４ｍ以上で再度チャレンジ
- 位置制御
  - 一応動いた：片輪のみ
- 残タスク
    - エンコーダーの値が振り切れる件
      - 急ぎ対応
    - 追加：速度上限設定
      - susumu関連すべてを変数の個数で２つ関数に　プロトタイプ宣言　速度上限設定
    - 右モータ故障？相談
      - arduino シールド：直つなぎラジコン化
      - RC8 レギュレータの影響？
      - ESCの交換 24mm か養生
      - 一旦動かして進める
    - パラメータフィッティング
      - 一旦はPDゲインで重たいものでも運べるようにPは大目に
    - リファクタリング：どこまで
      - やれる範囲で継続
    -  済：停止条件の相談＆実装
      - エンコーダーカウントストップで対応
      - 将来的には範囲内に〇ｍｓ間いればストップ
  
</details>

## 2022/10/17:MTG
<details>
<summary>詳細</summary>

- PIDの簡易版について、速度のPIDの係数は定数扱いとして、位置制御のPIDのパラメータフィッティングをやるで良い。位置の動きとしては電車ぐらいのイメージ
- 本格的な制御①とかはあとでやる。まずは動くもの
- 目標達成チェックはそのまま？→変更してよい：範囲で決めておく。（abs 600カウント数）
- 回転は現状４５度刻み周りで良い。〇将来的には度数で制御
- 今週タスク
  - 故障対応明日届き次第
  - PIDパラメータフィッティング：今週
  - バグFIX：今週
    - set_arduino_cmd_matrixのcmd_nをlong intにしたい、〇将来：UNOの場合は4バイト　MEGAは2バイトで切り替えたい。
    - 切り替え中の挙動見直し
  - リファクタリング
- 引っ越しは１１月後半頃？
</details>

## 2022/10/16
<details>
<summary>詳細</summary>

- リファクタリング　1330→866
- 本体の故障発生：https://cuborex.slack.com/archives/C03U9PNR09E/p1665887750979189
- ★void set_arduino_cmd_matrixこれがうまくいってない気がする。
　→故障回復後に要調査
- vscode導入 gitと連携済
- コード読み取り
　job_10msごとに
　↓check_mode_change()：モード（rc or arduino）識別
　　↓arduinoだったらarduino_mode()へ
　　　↓CMD_EXECUTE();
　　　　↓susumu→go_foward

- 前進の制御ロジック
- エンコーダのカウント数が目標距離を超えるまで速度を一定に制御、一定値を超えるとモーターの速度０を強制入力し修了を左右で実施。
- 疑問：どの制御までやるか？
  どちらかというとシーケンス制御になっている。どうやる？
- ２輪制御をするのか？するなら２輪モデルで制御が必要（今回はスコープ外？）
- 次元数にパラメータフィッティングに不要な変数が２つ増えるだけ全然うれしくない。
- 定数目標値で安定してたPIDの速度制御が可変の入力パラメータがもクフ王になった際の挙動が既存の３つのPIDパラメータフィッティングも必要になる可能性あり　簡易版が逆にいばらの道になりそう、、
- L側目標達成チェックはそのまま？線形制御とかみ合わない。発散せず、すごくきれいなパラメータが見つかれば問題ないが、、
- とはいえ簡易版追記：今日はおわり
</details>

## 2022/10/14
<details>
<summary>詳細</summary>

- メモを載せる：github gitにpushしてみる　cliでやりたい！！
- スケジュール
前半
・リファクタリング
・バグFIX
・PIDの仕組みまで作る→未着手よりかはまず手を付けてほしい　最低限のPDでも良い　
後半
・試験
・パラメータフィッティング
- 11月には５件くらい売る予定
- 目標　+-10cmくらい
- 目標距離→PID→速度の積分値→距離
  PID→モーター→速度
- 発振可能性はあるがまずは手を付ける：
　リファクタリング
　→進捗２００行程度は以降完了：動作も不具合なし
　→どこまでやるか相談　モータのクラス周りは少し触るのが大変
 →go_foward clockwiseは移動させる
 バグ回り：モード切替時のlong long intの数値確認
　　　　（エンコーダのカウント数のチェック）
- 気になる点
Arduinoモード中ではRCモードの支持はリセットしか受け付けないでよいか？
実行後はRCモードに変わる
なにもしなくても定期的にびくっとなる
バッテリの充電途中でぬいてもOK？
</details>

## y/m/d：作業orMTG
<details>
<summary>詳細</summary>
- テンプレ

</details>